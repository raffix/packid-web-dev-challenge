<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Monitor Sensor</title>
        <meta http-equiv="Content-Language" content="pt-br">
        <style>
            body {
                font-family: 'Poppins', sans-serif;
                color: #333;
                font-size: 14px;
                background: #f9f9ff;
            }

            h1, h2, h3, h4, h5, h6 {
                margin: 0.5em 0px;
            }

            .card {
                display: inline-block;
                width: 90%;
                margin: 1em 5%;
                padding: 0;
                
                background: #FFF;
                box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
                transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            }

            .card-title,
            .card-body {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;

                width: 90%;
                padding: 1em 5%;
                border-bottom: 1px solid #eaeaef;
            }

            #copyright {
                display: inline-block;
                width: 80%;
                padding: 0px 10%;
                text-align: center;
                background: #FFF;
            }

        </style>

        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    </head>
    <body>
        <header>
            <div class="card">
                <div class="card-title">
                    <h4 id="sensor-name"></h4>
                </div>
                <div class="card-body">
                    <span id="temperature-rate"></span>
                    <span id="temperature"></span>
                    <span id="temperature-average"></span>
                </div>
            </div>
        </header>
        <section>
            <div class="card">
                <div class="card-body">
                    <div id="temperature-filters">
                        <label>Data Inicial</label>
                        <input type="date" id="date-begin" name="date-begin">
                        <label>Data Final</label>
                        <input type="date" id="date-end" name="date-end">
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <canvas id="temperature-chart"></canvas>
                </div>
            </div>
        </section>
        <footer id="copyright">
            <span>Copyright - PackID 2018</span>
        </footer>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js" crossorigin="anonymous"></script>
        <script type="text/javascript">
        var colors = {
            red: 'rgb(255, 99, 132)',
            green: 'rgb(75, 192, 192)',
            blue: 'rgb(54, 162, 235)',
        }


        var intlDate = Intl.DateTimeFormat('pt-BR', { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false });
        
        var dataSet, min, max;
        var measurements = [];
        function loadData(data) {
            
            dataSet = JSON.parse(data);

            document.getElementById("sensor-name").innerHTML = dataSet.label;
            document.getElementById("temperature-rate").innerHTML = "Faixa de temperatura: " + dataSet.temperature_min + "ºC ~ " + dataSet.temperature_max + "ºC";
            document.getElementById("temperature").innerHTML = "Atualmente: " + dataSet.measurements[0].temperature + "ºC";

            dataSet.measurements.sort(function (a, b) {
                if(a.temperature < b.temperature) 
                    return -1;
                else if(a.temperature > b.temperature) 
                    return 1;
                return 0;
            })

            min = dataSet.temperature_min;
            max = dataSet.temperature_max;
            let media = 0.00;
            
            dataSet.measurements.forEach(element => {
                media += element.temperature;
                measurements.push({
                    date: intlDate.format(new Date(element.date_hour)),
                    temperature: element.temperature
                });
            });

            let temperatureAverage = media/measurements.length;
            document.getElementById("temperature-average").innerHTML = "Temperatura média: " + temperatureAverage + "ºC";
            loadChart();
        }

        function loadChart() {
            let labels = [], data = [], dataColors = [], borders = [], minData = [], maxData = [], maxColor = [], minColor = [];
            measurements.forEach(element => {
                data.push(element.temperature);
                labels.push(element.date);
                minData.push(min);
                maxData.push(max);

                if(element.temperature < min) 
                    dataColors.push(colors.blue);
                else if(element.temperature > max)
                    dataColors.push(colors.red);
                else
                    dataColors.push(colors.green);
            });

            
            let ctx = document.getElementById("temperature-chart").getContext('2d');
            let chart = new Chart(ctx, {
                type: 'bar',
                responsive: true,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperatura ºC',
                        data: data,
                        backgroundColor: dataColors,
                        borderColor: dataColors,
                        borderWidth: 1
                    },
                    {
                        label: 'Temperatura mínima ºC',
                        data: minData,
                        backgroundColor: colors.blue,
                        borderColor: colors.blue,
                        borderWidth: 0.3,
                        pointRadius: 0.2,
                        fill: false,
                        type: 'line'

                    },
                    {
                        label: 'Temperatura máxima ºC',
                        data: maxData,
                        backgroundColor: colors.red,
                        borderColor: colors.red,
                        borderWidth: 0.5,
                        pointRadius: 0.2,
                        fill: false,
                        type: 'line'
                    }]
                },
                options: {
                    tooltips: {
						mode: 'index',
						intersect: false,
					},
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero:true
                            }
                        }]
                    }
                }
            });
        }

        function requestData () {
            let url = "http://localhost/packid-web-dev-challenge/application/server.php";
            let request = new XMLHttpRequest();
            if (!request) {
                alert("Erro ao fazer requisição de dados.");
                return;
            }
            
            request.onreadystatechange = function () {
                // try{
                    if(request.readyState == XMLHttpRequest.DONE && request.status == 200)
                        loadData(request.responseText);
                // }catch (e) {
                //     alert("Exceção: " + e.description);
                // }
            }

            request.open("GET", url, true);
            request.send();
        }

        window.onload = function() 
        { 
            requestData();
        }

        </script>
    </body>
</html>